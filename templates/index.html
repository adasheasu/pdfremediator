<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASU PDF Remediation Tool - WCAG 2.2 AA Compliance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #8C1D40 0%, #FFC627 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .features {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .features h2 {
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .features ul {
            list-style: none;
            padding-left: 0;
        }

        .features li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .features li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #27ae60;
            font-weight: bold;
            font-size: 1.2em;
        }

        .upload-section {
            border: 3px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-section:hover {
            border-color: #8C1D40;
            background: #fff5e6;
        }

        .upload-section.dragover {
            border-color: #8C1D40;
            background: #fff5e6;
            transform: scale(1.02);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }

        .btn:focus {
            outline: 3px solid #8C1D40;
            outline-offset: 2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8C1D40 0%, #FFC627 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(140, 29, 64, 0.4);
        }

        .btn-secondary {
            background: #27ae60;
            color: white;
            margin: 5px;
        }

        .btn-secondary:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-info {
            background: #2196f3;
            color: white;
            margin: 5px;
        }

        .btn-info:hover {
            background: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        #actionButtons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        #actionButtons button {
            min-width: 250px;
        }

        @media (min-width: 600px) {
            #actionButtons {
                flex-direction: row;
                justify-content: center;
            }
        }

        #fileName {
            margin-top: 20px;
            font-size: 1.1em;
            color: #2c3e50;
            font-weight: 500;
        }

        .progress-container {
            display: none;
            margin: 30px 0;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8C1D40 0%, #FFC627 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-message {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #e8f5e9;
            border-radius: 12px;
            border-left: 5px solid #27ae60;
        }

        .results-section h2 {
            color: #27ae60;
            margin-bottom: 20px;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 5px solid #c62828;
            display: none;
        }

        .info-section {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .info-section h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-section p {
            color: #424242;
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .upload-section {
                padding: 20px;
            }

            .download-buttons {
                flex-direction: column;
            }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8C1D40;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .report-section {
            background: #fff8e1;
            border-left: 5px solid #ff9800;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            display: none;
        }

        .report-section.pass {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .report-section h3 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .report-section.pass h3 {
            color: #2e7d32;
        }

        .report-stats {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .report-stat {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-stat .number {
            font-size: 1.5em;
            font-weight: bold;
        }

        .report-stat.error .number {
            color: #d32f2f;
        }

        .report-stat.warning .number {
            color: #f57c00;
        }

        .report-stat.pass .number {
            color: #388e3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÑ ASU PDF Remediation Tool</h1>
            <p class="subtitle">Arizona State University | Convert, Remediate, and Export Accessible Documents</p>
            <span class="badge">WCAG 2.2 AA Compliant</span>
        </header>

        <section class="features">
            <h2>What This Tool Does:</h2>
            <ul>
                <li>Converts PDF documents to structured HTML</li>
                <li><strong>Two workflow options:</strong>
                    <ul style="margin-top: 8px; padding-left: 20px;">
                        <li><strong>üìä Analyze First</strong> - See accessibility issues before remediation (great for learning what needs fixing)</li>
                        <li><strong>üîß Remediate Now</strong> - Automatically fix all issues and generate compliant documents</li>
                    </ul>
                </li>
                <li>Remediates HTML for WCAG 2.2 AA accessibility compliance</li>
                <li>Adds proper semantic structure (headings, tables, landmarks)</li>
                <li>Ensures keyboard navigation and screen reader compatibility</li>
                <li>Generates accessible PDFs with proper tagging</li>
                <li>Provides detailed accessibility reports</li>
            </ul>
        </section>

        <main>
            <section class="upload-section" id="uploadSection">
                <h2>Upload Your PDF</h2>
                <p style="margin: 20px 0; color: #7f8c8d;">Drag and drop a PDF file here, or click to select</p>

                <div class="file-input-wrapper">
                    <label for="fileInput" class="btn btn-primary">
                        Choose PDF File
                    </label>
                    <input type="file" id="fileInput" accept=".pdf" aria-label="Choose PDF file for remediation">
                </div>

                <div id="fileName"></div>

                <div id="titleCustomization" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <label for="documentTitle" style="display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50;">
                        üìù Document Title (for accessibility)
                    </label>
                    <input
                        type="text"
                        id="documentTitle"
                        placeholder="Enter a descriptive title for this document"
                        style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 1em; margin-bottom: 8px;"
                        aria-label="Document title for accessibility"
                    >
                    <p style="font-size: 0.9em; color: #7f8c8d; margin: 0;">
                        üí° This title will be used by screen readers and will appear in the PDF metadata. A good title describes the document's purpose.
                    </p>
                </div>

                <div style="text-align: center; margin-top: 20px; display: none;" id="actionButtons">
                    <button class="btn btn-secondary" id="analyzeBtn" style="margin-right: 10px;">
                        üìä Analyze First (See Issues)
                    </button>
                    <button class="btn btn-primary" id="remediateBtn">
                        üîß Remediate Now
                    </button>
                </div>

                <div id="analysisResults" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">üìã Accessibility Analysis</h3>
                    <div id="analysisContent"></div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ffc107;">
                        <p style="font-weight: bold; color: #856404; margin-bottom: 15px;">
                            üí° What would you like to do?
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            <button class="btn btn-secondary" id="viewDetailedReport">
                                üìã View Full Detailed Report
                            </button>
                            <button class="btn btn-primary" id="proceedToRemediate">
                                ‚ú® Proceed with Automated Remediation
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="error-message" id="errorMessage" role="alert"></div>

            <div class="progress-container" id="progressContainer">
                <div class="spinner" id="spinner"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status-message" id="statusMessage">Processing your document...</div>
            </div>

            <section class="results-section" id="resultsSection">
                <h2>‚úÖ Remediation Complete!</h2>
                <p style="margin-bottom: 20px;">Your document has been successfully processed and is ready for download.</p>

                <div class="report-section" id="reportSection">
                    <h3 id="reportTitle">üìä Accessibility Report</h3>
                    <p id="reportSummary"></p>

                    <div class="report-stats" id="reportStats"></div>

                    <div class="download-buttons" style="margin-top: 15px;">
                        <button class="btn btn-secondary" id="viewFullReport" style="display: none;">
                            üìã View Full Report
                        </button>
                        <button class="btn btn-secondary" id="downloadReport" style="display: none;">
                            üì• Download Report (TXT)
                        </button>
                    </div>
                </div>

                <div class="download-buttons">
                    <button class="btn btn-secondary" id="downloadHtml" aria-label="Download remediated HTML file">
                        üì• Download HTML
                    </button>
                    <button class="btn btn-secondary" id="downloadPdf" aria-label="Download remediated PDF file">
                        üì• Download PDF
                    </button>
                    <button class="btn btn-info" id="interactiveRemediate" aria-label="Interactive remediation wizard" style="display: none;">
                        üîß Interactive Remediation
                    </button>
                    <button class="btn btn-primary" id="processAnother">
                        üîÑ Process Another Document
                    </button>
                </div>
            </section>
        </main>

        <section class="info-section">
            <h3>About WCAG 2.2 AA Compliance</h3>
            <p>
                This tool automatically applies Web Content Accessibility Guidelines (WCAG) 2.2 Level AA standards to your documents.
                This includes proper document structure, semantic HTML, keyboard navigation, screen reader compatibility,
                sufficient color contrast, and accessible tables and forms. The resulting documents are more usable for
                people with disabilities and improve the overall user experience for everyone.
            </p>
        </section>
    </div>

    <script>
        let currentSessionId = null;
        let selectedFile = null;
        let currentAnalysisReport = null;  // Store analysis report for viewing
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileName = document.getElementById('fileName');
        const remediateBtn = document.getElementById('remediateBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');
        const spinner = document.getElementById('spinner');
        const downloadHtml = document.getElementById('downloadHtml');
        const downloadPdf = document.getElementById('downloadPdf');
        const processAnother = document.getElementById('processAnother');

        // File input change handler
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop handlers
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showError('Please select a PDF file.');
                return;
            }

            selectedFile = file;
            fileName.textContent = `üìÑ Selected: ${file.name}`;
            fileName.style.fontWeight = 'bold';
            fileName.style.color = '#8C1D40';
            fileName.style.marginTop = '10px';

            // Show title customization and suggest a title
            const titleCustomization = document.getElementById('titleCustomization');
            const documentTitle = document.getElementById('documentTitle');
            titleCustomization.style.display = 'block';

            // Generate suggested title from filename
            let suggestedTitle = file.name
                .replace(/\.pdf$/i, '')  // Remove .pdf extension
                .replace(/_/g, ' ')      // Replace underscores with spaces
                .replace(/\s+/g, ' ')    // Normalize spaces
                .trim();

            // Capitalize first letter of each word for readability
            suggestedTitle = suggestedTitle.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            documentTitle.value = suggestedTitle;

            // Show both action buttons
            document.getElementById('actionButtons').style.display = 'block';

            // Hide analysis results if showing from previous upload
            document.getElementById('analysisResults').style.display = 'none';

            // Clear any previous errors
            errorMessage.style.display = 'none';
        }

        // Analyze button click handler
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            if (selectedFile) {
                analyzeFile(selectedFile);
            }
        });

        // Proceed to remediate from analysis
        document.getElementById('proceedToRemediate').addEventListener('click', () => {
            // Show title customization
            document.getElementById('titleCustomization').style.display = 'block';
            // Scroll to title input
            document.getElementById('titleCustomization').scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Change button text to indicate we're continuing
            const remediateBtn = document.getElementById('remediateBtn');
            remediateBtn.textContent = '‚ú® Complete Remediation';
            remediateBtn.style.display = 'inline-block';
            document.getElementById('analyzeBtn').style.display = 'none';
        });

        // View detailed report from analysis
        document.getElementById('viewDetailedReport').addEventListener('click', () => {
            if (currentAnalysisReport) {
                openFullReport(currentAnalysisReport);
            }
        });

        // Remediate button click handler
        remediateBtn.addEventListener('click', () => {
            if (selectedFile) {
                uploadFile(selectedFile);
            }
        });

        async function analyzeFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Show progress
            errorMessage.style.display = 'none';
            progressContainer.style.display = 'block';
            resultsSection.style.display = 'none';
            spinner.style.display = 'block';
            progressFill.style.width = '50%';
            progressFill.textContent = '50%';
            statusMessage.textContent = 'Analyzing PDF for accessibility issues...';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Analysis failed');
                }

                // Complete progress
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                statusMessage.textContent = 'Analysis complete!';
                spinner.style.display = 'none';

                // Store report for viewing
                currentAnalysisReport = data.accessibility_report;

                // Hide progress and show analysis results
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    displayAnalysisResults(data.accessibility_report);
                }, 500);

            } catch (error) {
                showError(error.message);
                progressContainer.style.display = 'none';
                spinner.style.display = 'none';
            }
        }

        function displayAnalysisResults(report) {
            const analysisResults = document.getElementById('analysisResults');
            const analysisContent = document.getElementById('analysisContent');

            let html = `
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 2em; font-weight: bold; color: ${report.compliance_score >= 80 ? '#28a745' : report.compliance_score >= 60 ? '#ffc107' : '#dc3545'};">
                        ${report.compliance_score}%
                    </div>
                    <div style="color: #6c757d;">Current Accessibility Score</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: ${report.issues_count > 0 ? '#f8d7da' : '#d4edda'}; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: ${report.issues_count > 0 ? '#721c24' : '#155724'};">
                            ${report.issues_count}
                        </div>
                        <div style="font-size: 0.9em; color: ${report.issues_count > 0 ? '#721c24' : '#155724'};">Critical Issues</div>
                    </div>
                    <div style="padding: 15px; background: #fff3cd; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #856404;">${report.warnings_count}</div>
                        <div style="font-size: 0.9em; color: #856404;">Warnings</div>
                    </div>
                    <div style="padding: 15px; background: #d4edda; border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #155724;">${report.passed_count}</div>
                        <div style="font-size: 0.9em; color: #155724;">Checks Passed</div>
                    </div>
                </div>
            `;

            if (report.issues_count > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #721c24; margin-bottom: 10px;">üî¥ Issues Found:</h4><ul style="margin-left: 20px;">';
                report.issues.forEach(issue => {
                    html += `<li style="margin-bottom: 10px;">
                        <strong>${issue.title}</strong><br>
                        <span style="color: #666; font-size: 0.9em;">${issue.description}</span><br>
                        <em style="color: #007bff; font-size: 0.85em;">üí° ${issue.remediation.replace(/<[^>]*>/g, '')}</em>
                    </li>`;
                });
                html += '</ul></div>';
            }

            if (report.warnings_count > 0) {
                html += '<div style="margin-top: 20px;"><h4 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Warnings:</h4><ul style="margin-left: 20px;">';
                report.warnings.forEach(warning => {
                    html += `<li style="margin-bottom: 10px;">
                        <strong>${warning.title}</strong><br>
                        <span style="color: #666; font-size: 0.9em;">${warning.description}</span>
                    </li>`;
                });
                html += '</ul></div>';
            }

            analysisContent.innerHTML = html;
            analysisResults.style.display = 'block';
            analysisResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function openFullReport(report) {
            // Generate full HTML report
            const reportHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Analysis Report</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 40px;
        }
        .header {
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 3px solid #8C1D40;
            margin-bottom: 30px;
        }
        h1 { color: #8C1D40; font-size: 2.5em; margin-bottom: 10px; }
        .subtitle { color: #666; font-size: 1.1em; }
        .score-section {
            text-align: center;
            padding: 30px;
            background: ${report.compliance_score >= 80 ? 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)' : report.compliance_score >= 60 ? 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)' : 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)'};
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .score {
            font-size: 4em;
            font-weight: bold;
            color: ${report.compliance_score >= 80 ? '#155724' : report.compliance_score >= 60 ? '#856404' : '#721c24'};
        }
        .score-label { font-size: 1.2em; color: #666; margin-top: 10px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-card.error { background: #f8d7da; border: 2px solid #f5c6cb; }
        .stat-card.warning { background: #fff3cd; border: 2px solid #ffeaa7; }
        .stat-card.success { background: #d4edda; border: 2px solid #c3e6cb; }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .stat-card.error .stat-number { color: #721c24; }
        .stat-card.warning .stat-number { color: #856404; }
        .stat-card.success .stat-number { color: #155724; }
        .stat-label {
            font-size: 1em;
            font-weight: 500;
        }
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        .issue-item, .warning-item, .passed-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .issue-item {
            background: #fff5f5;
            border-left-color: #dc3545;
        }
        .warning-item {
            background: #fffef5;
            border-left-color: #ffc107;
        }
        .passed-item {
            background: #f5fff5;
            border-left-color: #28a745;
        }
        .item-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .issue-item .item-title { color: #721c24; }
        .warning-item .item-title { color: #856404; }
        .passed-item .item-title { color: #155724; }
        .item-description {
            color: #555;
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .item-remediation {
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        .item-remediation strong {
            color: #007bff;
            display: block;
            margin-bottom: 8px;
        }
        .guideline {
            display: inline-block;
            padding: 4px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 0.9em;
            color: #495057;
            margin-top: 10px;
        }
        .timestamp {
            text-align: center;
            color: #999;
            font-size: 0.9em;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Accessibility Analysis Report</h1>
            <p class="subtitle">WCAG 2.2 Level AA Compliance Analysis</p>
        </div>

        <div class="score-section">
            <div class="score">${report.compliance_score}%</div>
            <div class="score-label">Overall Accessibility Score</div>
        </div>

        <div class="stats">
            <div class="stat-card error">
                <div class="stat-number">${report.issues_count}</div>
                <div class="stat-label">Critical Issue${report.issues_count !== 1 ? 's' : ''}</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number">${report.warnings_count}</div>
                <div class="stat-label">Warning${report.warnings_count !== 1 ? 's' : ''}</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number">${report.passed_count}</div>
                <div class="stat-label">Check${report.passed_count !== 1 ? 's' : ''} Passed</div>
            </div>
        </div>

        ${report.issues_count > 0 ? `
        <div class="section">
            <h2 class="section-title">üî¥ Critical Issues (${report.issues_count})</h2>
            ${report.issues.map(issue => `
                <div class="issue-item">
                    <div class="item-title">${issue.title}</div>
                    <div class="item-description">${issue.description}</div>
                    <div class="item-remediation">
                        <strong>üí° How to Fix:</strong>
                        ${issue.remediation}
                    </div>
                    <span class="guideline">WCAG ${issue.guideline} - ${issue.guideline_name} (Level ${issue.level})</span>
                </div>
            `).join('')}
        </div>
        ` : ''}

        ${report.warnings_count > 0 ? `
        <div class="section">
            <h2 class="section-title">‚ö†Ô∏è Warnings (${report.warnings_count})</h2>
            ${report.warnings.map(warning => `
                <div class="warning-item">
                    <div class="item-title">${warning.title}</div>
                    <div class="item-description">${warning.description}</div>
                    <div class="item-remediation">
                        <strong>üí° Recommendation:</strong>
                        ${warning.remediation}
                    </div>
                    <span class="guideline">WCAG ${warning.guideline} - ${warning.guideline_name} (Level ${warning.level})</span>
                </div>
            `).join('')}
        </div>
        ` : ''}

        ${report.passed_count > 0 ? `
        <div class="section">
            <h2 class="section-title">‚úÖ Passed Checks (${report.passed_count})</h2>
            ${report.passed_checks.map(check => `
                <div class="passed-item">
                    <div class="item-title">${check.title}</div>
                    <span class="guideline">WCAG ${check.guideline} - ${check.guideline_name}</span>
                </div>
            `).join('')}
        </div>
        ` : ''}

        <div class="timestamp">
            Report generated: ${report.timestamp || new Date().toLocaleString()}
        </div>
    </div>
</body>
</html>
            `;

            // Open report in new window
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Add custom document title
            const documentTitle = document.getElementById('documentTitle');
            if (documentTitle && documentTitle.value.trim()) {
                formData.append('document_title', documentTitle.value.trim());
            }

            // Show progress
            errorMessage.style.display = 'none';
            progressContainer.style.display = 'block';
            resultsSection.style.display = 'none';
            spinner.style.display = 'block';
            progressFill.style.width = '30%';
            progressFill.textContent = '30%';
            statusMessage.textContent = 'Uploading and converting PDF to HTML...';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }

                // Update progress
                progressFill.style.width = '60%';
                progressFill.textContent = '60%';
                statusMessage.textContent = 'Remediating HTML for accessibility...';

                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 1000));

                progressFill.style.width = '90%';
                progressFill.textContent = '90%';
                statusMessage.textContent = 'Converting to PDF...';

                await new Promise(resolve => setTimeout(resolve, 500));

                // Complete
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                statusMessage.textContent = 'Complete!';
                spinner.style.display = 'none';

                currentSessionId = data.session_id;

                // Display accessibility report if available
                if (data.accessibility_report) {
                    displayAccessibilityReport(data.accessibility_report, data.session_id, data.has_issues);
                }

                // Show results after a brief delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    resultsSection.style.display = 'block';
                }, 500);

            } catch (error) {
                showError(error.message);
                progressContainer.style.display = 'none';
                spinner.style.display = 'none';
            }
        }

        function displayAccessibilityReport(report, sessionId, hasIssues) {
            const reportSection = document.getElementById('reportSection');
            const reportTitle = document.getElementById('reportTitle');
            const reportSummary = document.getElementById('reportSummary');
            const reportStats = document.getElementById('reportStats');
            const viewFullReport = document.getElementById('viewFullReport');
            const downloadReport = document.getElementById('downloadReport');

            // Show report section
            reportSection.style.display = 'block';

            // Update styling based on pass/fail
            if (!hasIssues) {
                reportSection.classList.add('pass');
                reportTitle.textContent = '‚úÖ Accessibility Report - Passed!';
                reportSummary.textContent = `Excellent! Your document passed all WCAG 2.2 AA accessibility checks with a score of ${report.compliance_score}%.`;
            } else {
                reportSection.classList.remove('pass');
                reportTitle.textContent = 'üìä Accessibility Report';
                reportSummary.textContent = `Your document scored ${report.compliance_score}% on WCAG 2.2 AA compliance. ${report.issues_count} issue(s) found that need attention.`;
            }

            // Display statistics
            reportStats.innerHTML = '';

            if (report.issues_count > 0) {
                const errorStat = document.createElement('div');
                errorStat.className = 'report-stat error';
                errorStat.innerHTML = `
                    <div class="number">${report.issues_count}</div>
                    <div>Issue${report.issues_count !== 1 ? 's' : ''}</div>
                `;
                reportStats.appendChild(errorStat);
            }

            if (report.warnings_count > 0) {
                const warningStat = document.createElement('div');
                warningStat.className = 'report-stat warning';
                warningStat.innerHTML = `
                    <div class="number">${report.warnings_count}</div>
                    <div>Warning${report.warnings_count !== 1 ? 's' : ''}</div>
                `;
                reportStats.appendChild(warningStat);
            }

            const passStat = document.createElement('div');
            passStat.className = 'report-stat pass';
            passStat.innerHTML = `
                <div class="number">${report.passed_count}</div>
                <div>Passed</div>
            `;
            reportStats.appendChild(passStat);

            // Show/hide report buttons
            if (hasIssues) {
                viewFullReport.style.display = 'inline-block';
                downloadReport.style.display = 'inline-block';

                // Wire up buttons
                viewFullReport.onclick = () => {
                    window.open(`/report/${sessionId}`, '_blank');
                };

                downloadReport.onclick = () => {
                    window.location.href = `/download/${sessionId}/report_txt`;
                };

                // Show interactive remediation button
                const interactiveBtn = document.getElementById('interactiveRemediate');
                if (interactiveBtn) {
                    interactiveBtn.style.display = 'inline-block';
                    interactiveBtn.onclick = () => {
                        window.location.href = `/remediate/${sessionId}`;
                    };
                }
            } else {
                viewFullReport.style.display = 'none';
                downloadReport.style.display = 'none';
                document.getElementById('interactiveRemediate').style.display = 'none';
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        downloadHtml.addEventListener('click', () => {
            if (currentSessionId) {
                window.location.href = `/download/${currentSessionId}/html`;
            }
        });

        downloadPdf.addEventListener('click', () => {
            if (currentSessionId) {
                window.location.href = `/download/${currentSessionId}/pdf`;
            }
        });

        processAnother.addEventListener('click', () => {
            // Clean up old session
            if (currentSessionId) {
                fetch(`/cleanup/${currentSessionId}`, { method: 'POST' });
            }

            // Reset UI
            currentSessionId = null;
            selectedFile = null;
            fileInput.value = '';
            fileName.textContent = '';
            remediateBtn.style.display = 'none';
            resultsSection.style.display = 'none';
            progressContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            progressFill.style.width = '0%';

            // Reset report section
            const reportSection = document.getElementById('reportSection');
            reportSection.style.display = 'none';
            reportSection.classList.remove('pass');
        });
    </script>
</body>
</html>
